name: build & tests & release

on:
  push:
    tags:
      - "v*.*.*"

env:
  DOTNET_VERSION: "9.0.x"
  PROFILE: Release # Release | Debug
  NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages

jobs:
  build_and_test:
    name: Build and Test
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Extract version (strip leading v)
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_ENV
        shell: bash

      - name: Build & Test
        uses: ./.github/actions/build-and-test
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
          configuration: ${{ env.PROFILE }}
          solution-path: "./Pandora+.sln"

  create_release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build_and_test
    permissions:
      contents: write 
    steps:
      - name: Create empty GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ github.ref_name }}
        run: |
          gh release create "$TAG_NAME" \
            --title "Pandora Behaviour Engine $TAG_NAME" \
            --generate-notes

  publish:
    name: Publish Cross-Platform Assets
    permissions:
      contents: write
    runs-on: ${{ matrix.runner }}
    needs: create_release

    strategy:
      matrix:
        include:
          # Windows targets
          - rid: win-x64
            runner: windows-latest
            output-dir: Output.Win-x64
          - rid: win-x86
            runner: windows-latest
            output-dir: Output.Win-x86
          - rid: win-arm64
            runner: windows-latest
            output-dir: Output.Win-Arm64
          # Linux targets
          - rid: linux-x64
            runner: ubuntu-latest
            output-dir: Output.Linux-x64
          - rid: linux-arm
            runner: ubuntu-latest
            output-dir: Output.Linux-Arm
          - rid: linux-arm64
            runner: ubuntu-latest
            output-dir: Output.Linux-Arm64
          - rid: linux-musl-x64
            runner: ubuntu-latest
            output-dir: Output.Linux-Musl-x64

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Extract version (strip leading v)
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_ENV
        shell: bash

      - name: Publish Self-Contained
        shell: pwsh
        run: |
          dotnet publish "./Pandora Behaviour Engine/Pandora Behaviour Engine.csproj" `
            -c ${{ env.PROFILE }} `
            -r ${{ matrix.rid }} `
            -o "${{ github.workspace }}/${{ matrix.output-dir }}" `
            --self-contained true `
            /p:PublishSingleFile=true `
            /p:IncludeAllContentForSelfExtract=true `
            /p:Version=${{ env.VERSION }} `
            /p:AssemblyVersion=${{ env.VERSION }} `
            /p:FileVersion=${{ env.VERSION }}

      - name: Zip and Upload Asset
        uses: ./.github/actions/zip-and-release
        with:
          tag: ${{ github.ref_name }}
          output-dir: ${{ matrix.output-dir }}
          zip-path: "${{ matrix.output-dir }}/Pandora_Behaviour_Engine_${{ github.ref_name }}_${{ matrix.rid }}_net.zip"
          github-token: ${{ secrets.GITHUB_TOKEN }}
